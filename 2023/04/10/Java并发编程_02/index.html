<!DOCTYPE html>
<html lang="zh-CN">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="äºŒã€Javaå¹¶å‘ç¼–ç¨‹-å¹¶å‘åŸºç¡€" />
    <meta name="hexo-theme-A4" content="v1.9.7" />
    <link rel="alternate icon" type="image/webp" href="/img/avatar.png">
    <title>Ethan-é€é“æ—¥è®° | true</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery-bundle.min.css">


   
        
<link rel="stylesheet" href="/css/custom.css">

    

<meta name="generator" content="Hexo 7.3.0"></head>
    
    
        <style>
            .index-main{
                max-width:  1200px;
            }
        </style>

    
    



    

    
    




    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        <script>
            const options = {
                bottom: '40px', // default: '32px'
                right: 'unset', // default: '32px'
                left: '42px', // default: 'unset'
                time: '0.3s', // default: '0.3s'
                mixColor: '#fff', // default: '#fff'
                backgroundColor: ' #e4e4e4 ',  // default: '#fff'
                buttonColorDark: '#100f2c',  // default: '#100f2c'
                buttonColorLight: '#fff', // default: '#fff'
                saveInCookies: true, // default: true,
                label: 'ğŸŒ“', // default: ''
                autoMatchOsTheme: true // default: true
            }
            const darkmode = new Darkmode(options);
            darkmode.showWidget();
        </script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    

    <div class="index-header-line" >
        <div id="hiddenHeaderContentArray" style="display: none;">
            
            
            
                <span>Your only limit is your mind.</span>
            
        </div>
        <span id="targetSpan"></span>
    </div>


<div class="header">
    <div class="header-container">
        <style>
            .header-img {
                width: 56px;
                height: auto;
                object-fit: cover; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ */
                transition: transform 0.3s ease-in-out; 
                border-radius: 0; 
            }
            
        </style>
        <img 
            alt="^-^" 
            cache-control="max-age=86400" 
            class="header-img" 
            src="/img/avatar.png" 
        />
        <div class="header-content">
            <a class="logo" href="/">Ethan-é€é“æ—¥è®°</a> 
            <span class="description">é€æœ‰é“æ— æœ¯ä¹‹é“</span> 
        </div>
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">é¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">æ–‡ç« </a></li>
            
        
            
                <li><a href="/tags/">æ ‡ç­¾</a></li>
            
        
            
                <li><a href="/categories/">åˆ†ç±»</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">
    

    
        
            
                <div class="post-main-title" style="text-align: center;">
                    äºŒã€Javaå¹¶å‘ç¼–ç¨‹-å¹¶å‘åŸºç¡€
                </div>
            
        
      
    

    

        
            <div class="post-head-meta-center">
        
                
                    <span>æœ€è¿‘æ›´æ–°ï¼š2025-03-20</span> 
                
                
                    
                        &nbsp; | &nbsp;
                    
                     <span>å­—æ•°æ€»è®¡ï¼š7.5k</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span>é˜…è¯»ä¼°æ—¶ï¼š29åˆ†é’Ÿ</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span id="busuanzi_container_page_pv">
                        é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>æ¬¡
                    </span>
                
            </div>
    

    <div class="post-md">
        
            
        
        <div class=".article-gallery"><h1 id="Javaå¹¶å‘ç¼–ç¨‹-å¹¶å‘åŸºç¡€"><a href="#Javaå¹¶å‘ç¼–ç¨‹-å¹¶å‘åŸºç¡€" class="headerlink" title="Javaå¹¶å‘ç¼–ç¨‹-å¹¶å‘åŸºç¡€"></a>Javaå¹¶å‘ç¼–ç¨‹-å¹¶å‘åŸºç¡€</h1><h2 id="1-ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹"><a href="#1-ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹" class="headerlink" title="1. ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹"></a>1. ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹</h2><p><strong>å¹¶å‘</strong>ï¼šæŒ‡åœ¨åŒä¸€æ—¶é—´æ®µå†…ï¼Œå¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œä¸”éƒ½æœªå®Œæˆã€‚å¯ä»¥ç†è§£ä¸ºä»»åŠ¡äº¤æ›¿æ‰§è¡Œï¼Œç”±å¤šä¸ªæ—¶é—´ç‰‡æ„æˆä¸€ä¸ªæ—¶é—´æ®µã€‚</p>
<p><strong>å¹¶è¡Œ</strong>ï¼šæŒ‡åœ¨æŸä¸ªå•ä½æ—¶é—´å†…ï¼Œå¤šä¸ªä»»åŠ¡çœŸæ­£åŒæ—¶æ‰§è¡Œï¼Œé€šå¸¸ä¾èµ–äºå¤šæ ¸å¤„ç†å™¨çš„æ”¯æŒã€‚</p>
<p>åœ¨å•æ ¸ CPU ä½“ç³»ä¸‹ï¼Œå¤šä¸ªä»»åŠ¡åªèƒ½é€šè¿‡ CPU è°ƒåº¦è¿›è¡Œåˆ‡æ¢ï¼Œå½¢æˆå¹¶å‘æ‰§è¡Œçš„æ•ˆæœï¼Œä½†å®é™…ä»ç„¶æ˜¯ä¸²è¡Œæ‰§è¡Œã€‚å¤šçº¿ç¨‹ç¼–ç¨‹åœ¨è¿™ç§æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´é¢‘ç¹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¢åŠ é¢å¤–å¼€é”€ã€‚ä¾‹å¦‚ï¼Œå•æ ¸ CPU è¿è¡Œå¤šä¸ªçº¿ç¨‹æ—¶ï¼Œçº¿ç¨‹ä¹‹é—´éœ€è¦ä¸æ–­ç­‰å¾… CPU è¿›è¡Œè°ƒåº¦ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="/../img/juc/02.jpg" class="gallery-item" style="box-shadow: none;"> <img src="/../img/juc/02.jpg"></a></p>
<h2 id="2-ä¸ºä»€ä¹ˆè¦è¿›è¡Œå¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹"><a href="#2-ä¸ºä»€ä¹ˆè¦è¿›è¡Œå¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹" class="headerlink" title="2. ä¸ºä»€ä¹ˆè¦è¿›è¡Œå¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹"></a>2. ä¸ºä»€ä¹ˆè¦è¿›è¡Œå¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹</h2><p>éšç€å¤šæ ¸ CPU çš„æ™®åŠï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥ç‹¬å  CPU æ ¸å¿ƒè¿›è¡Œè®¡ç®—ï¼Œå‡å°‘äº†å•çº¿ç¨‹æ¨¡å¼ä¸‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚ç„¶è€Œï¼Œåœ¨å¤„ç†<strong>æµ·é‡æ•°æ®ã€å¹¶å‘è¯·æ±‚</strong>ç­‰åœºæ™¯æ—¶ï¼Œå•çº¿ç¨‹å·²ç»æ— æ³•æ»¡è¶³é«˜æ€§èƒ½çš„éœ€æ±‚ï¼Œå› æ­¤<strong>å¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹æˆä¸ºæå‡ç³»ç»Ÿååé‡å’Œå“åº”é€Ÿåº¦çš„é‡è¦æ‰‹æ®µ</strong>ã€‚</p>
<p>å¤šçº¿ç¨‹çš„ä¸»è¦ä¼˜åŠ¿ï¼š</p>
<ul>
<li><strong>å……åˆ†åˆ©ç”¨ CPU èµ„æº</strong>ï¼šå¤šæ ¸ CPU å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œæé«˜è®¡ç®—æ•ˆç‡ã€‚</li>
<li><strong>æé«˜ç³»ç»Ÿååé‡</strong>ï¼šåœ¨ I&#x2F;O å¯†é›†å‹ä»»åŠ¡ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æŸ¥è¯¢ï¼‰ä¸­ï¼Œå¤šçº¿ç¨‹å¯ä»¥åœ¨ç­‰å¾… I&#x2F;O æœŸé—´æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œæå‡æ•´ä½“å¤„ç†èƒ½åŠ›ã€‚</li>
<li><strong>å¢å¼ºç¨‹åºå“åº”èƒ½åŠ›</strong>ï¼šåœ¨ GUI ç¨‹åºæˆ– Web æœåŠ¡å™¨ä¸­ï¼Œä½¿ç”¨å¤šçº¿ç¨‹å¯ä»¥é¿å…å› å•ä¸ªä»»åŠ¡é˜»å¡è€Œå½±å“æ•´ä½“å“åº”ã€‚</li>
</ul>
<h2 id="3-Javaä¸­çš„çº¿ç¨‹å®‰å…¨é—®é¢˜"><a href="#3-Javaä¸­çš„çº¿ç¨‹å®‰å…¨é—®é¢˜" class="headerlink" title="3. Javaä¸­çš„çº¿ç¨‹å®‰å…¨é—®é¢˜"></a>3. Javaä¸­çš„çº¿ç¨‹å®‰å…¨é—®é¢˜</h2><p><strong>å…±äº«èµ„æº</strong>ï¼šæŒ‡å¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®æˆ–æŒæœ‰çš„èµ„æºï¼Œå¦‚å…¨å±€å˜é‡ã€é™æ€å˜é‡ã€æ•°æ®åº“è¿æ¥ç­‰ã€‚</p>
<p><strong>çº¿ç¨‹å®‰å…¨é—®é¢˜</strong>ï¼šå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™å…±äº«èµ„æºä¸”æœªé‡‡å–åŒæ­¥æªæ–½æ—¶ï¼Œå¯èƒ½ä¼šå¼•å‘<strong>æ•°æ®ä¸ä¸€è‡´ã€è„æ•°æ®</strong>ç­‰é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¿›è¡Œè®¡æ•°æ“ä½œï¼š</p>
<table>
<thead>
<tr>
<th>æ—¶é—´</th>
<th>çº¿ç¨‹ A</th>
<th>çº¿ç¨‹ B</th>
<th>å†…å­˜ count</th>
</tr>
</thead>
<tbody><tr>
<td>t1</td>
<td>è¯»å– count&#x3D;0</td>
<td></td>
<td>0</td>
</tr>
<tr>
<td>t2</td>
<td>count + 1 &#x3D; 1</td>
<td>è¯»å– count&#x3D;0</td>
<td>0</td>
</tr>
<tr>
<td>t3</td>
<td>å†™å› count&#x3D;1</td>
<td>count + 1 &#x3D; 1</td>
<td>1</td>
</tr>
<tr>
<td>t4</td>
<td></td>
<td>å†™å› count&#x3D;1</td>
<td>1</td>
</tr>
</tbody></table>
<p>å‡è®¾ <code>count</code> åˆå§‹å€¼ä¸º 0ï¼Œçº¿ç¨‹ A å’Œçº¿ç¨‹ B åŒæ—¶æ‰§è¡Œè‡ªå¢æ“ä½œï¼š</p>
<ul>
<li><code>t1</code>ï¼šçº¿ç¨‹ A è¯»å– <code>count=0</code>ï¼Œå‡†å¤‡è¿›è¡Œè‡ªå¢ã€‚</li>
<li><code>t2</code>ï¼šçº¿ç¨‹ A è®¡ç®— <code>count+1=1</code>ï¼Œä½†è¿˜æœªå†™å›å†…å­˜ï¼ŒåŒæ—¶çº¿ç¨‹ B è¯»å– <code>count=0</code>ã€‚</li>
<li><code>t3</code>ï¼šçº¿ç¨‹ A å°† <code>count=1</code> å†™å›ä¸»å†…å­˜ï¼Œè€Œçº¿ç¨‹ B æ­¤æ—¶ä»ç„¶æŒæœ‰ <code>count=0</code>ã€‚</li>
<li><code>t4</code>ï¼šçº¿ç¨‹ B è®¡ç®— <code>count+1=1</code>ï¼Œç„¶åå†™å›ä¸»å†…å­˜ï¼Œå¯¼è‡´ <code>count</code> ä»ç„¶æ˜¯ <code>1</code>ï¼Œä¸¢å¤±äº†ä¸€æ¬¡é€’å¢æ“ä½œã€‚</li>
</ul>
<p>å°½ç®¡æ‰§è¡Œäº†ä¸¤æ¬¡é€’å¢æ“ä½œï¼Œ<code>count</code> çš„æœ€ç»ˆå€¼ä»ç„¶ä¸º <code>1</code>ï¼Œå¯¼è‡´<strong>æ•°æ®ä¸ä¸€è‡´</strong>ï¼Œè¿™å°±æ˜¯å…¸å‹çš„<strong>å…±äº«å˜é‡çš„çº¿ç¨‹å®‰å…¨é—®é¢˜</strong>ã€‚</p>
<h2 id="4-Java-ä¸­å…±äº«å˜é‡çš„å†…å­˜å¯è§æ€§é—®é¢˜"><a href="#4-Java-ä¸­å…±äº«å˜é‡çš„å†…å­˜å¯è§æ€§é—®é¢˜" class="headerlink" title="4. Java ä¸­å…±äº«å˜é‡çš„å†…å­˜å¯è§æ€§é—®é¢˜"></a>4. Java ä¸­å…±äº«å˜é‡çš„å†…å­˜å¯è§æ€§é—®é¢˜</h2><p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„<strong>å·¥ä½œå†…å­˜ï¼ˆç¼“å­˜ï¼‰</strong>ï¼Œå®ƒä¼šä»<strong>ä¸»å†…å­˜</strong>ä¸­è¯»å–æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œå¹¶åœ¨æŸä¸ªæ—¶åˆ»å°†ä¿®æ”¹åçš„æ•°æ®å†™å›ä¸»å†…å­˜ã€‚è¿™ç§<strong>ç¼“å­˜æœºåˆ¶</strong>å¯èƒ½å¯¼è‡´çº¿ç¨‹ä¹‹é—´çš„æ•°æ®ä¸ä¸€è‡´ï¼Œå½¢æˆ<strong>å†…å­˜å¯è§æ€§é—®é¢˜</strong>ã€‚</p>
<p>Java å†…å­˜æ¨¡å‹ï¼ˆJMMï¼ŒJava Memory Modelï¼‰è§„å®šï¼š</p>
<ol>
<li>æ‰€æœ‰å˜é‡éƒ½å­˜å‚¨åœ¨<strong>ä¸»å†…å­˜</strong>ä¸­ã€‚</li>
<li>æ¯ä¸ªçº¿ç¨‹åœ¨ä½¿ç”¨å˜é‡æ—¶ï¼Œéƒ½ä¼šä»ä¸»å†…å­˜å¤åˆ¶åˆ°è‡ªå·±çš„<strong>å·¥ä½œå†…å­˜</strong>ï¼ˆCPU ç¼“å­˜æˆ–å¯„å­˜å™¨ï¼‰ã€‚</li>
<li>çº¿ç¨‹å¯¹å˜é‡çš„ä¿®æ”¹ä¸ä¼šç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿæ— æ³•ç«‹åˆ»çœ‹åˆ°æœ€æ–°å€¼ã€‚</li>
</ol>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="/../img/juc/03.jpg" class="gallery-item" style="box-shadow: none;"> <img src="/../img/juc/03.jpg"></a></p>
<p><a href="/../img/juc/04.jpg" class="gallery-item" style="box-shadow: none;"> <img src="/../img/juc/04.jpg"></a></p>
<p><strong>å†…å­˜å¯è§æ€§é—®é¢˜çš„å…¸å‹è¡¨ç°</strong>ï¼š</p>
<ul>
<li>çº¿ç¨‹ A ä¿®æ”¹äº†å…±äº«å˜é‡ï¼Œä½†çº¿ç¨‹ B ä»ç„¶è¯»å–çš„æ˜¯æ—§å€¼ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</li>
<li>çº¿ç¨‹ B å¯¹å˜é‡çš„ä¿®æ”¹å¯èƒ½ä¸ä¼šç«‹åˆ»åæ˜ åˆ°ä¸»å†…å­˜ä¸­ï¼Œå½±å“å…¶ä»–çº¿ç¨‹çš„è¯»å–ã€‚</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>volatile</code> å…³é”®å­—ï¼Œä¿è¯å˜é‡çš„å¯è§æ€§ï¼ˆä½†ä¸ä¿è¯åŸå­æ€§ï¼‰ã€‚</li>
<li>é‡‡ç”¨ <code>synchronized</code> æˆ– <code>Lock</code> æœºåˆ¶ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚</li>
<li>ä½¿ç”¨ <strong>åŸå­ç±»ï¼ˆAtomicInteger ç­‰ï¼‰</strong> æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚</li>
</ul>
<h2 id="5-Java-ä¸­çš„-synchronized-å’Œ-volatile"><a href="#5-Java-ä¸­çš„-synchronized-å’Œ-volatile" class="headerlink" title="5. Java ä¸­çš„ synchronized å’Œ volatile"></a>5. Java ä¸­çš„ <code>synchronized</code> å’Œ <code>volatile</code></h2><p>åœ¨ Java ä¸­ï¼Œ<strong>å¯è§æ€§é—®é¢˜</strong> å¯ä»¥é€šè¿‡ <code>synchronized</code> å’Œ <code>volatile</code> è§£å†³ï¼Œå®ƒä»¬åœ¨<strong>å†…å­˜å¯è§æ€§</strong>å’Œ<strong>åŒæ­¥æœºåˆ¶</strong>ä¸Šå„æœ‰ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚</p>
<h3 id="5-1-synchronized"><a href="#5-1-synchronized" class="headerlink" title="5.1 synchronized"></a>5.1 <code>synchronized</code></h3><h4 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. <strong>ç®€ä»‹</strong></h4><p><code>synchronized</code> æ˜¯ Java æä¾›çš„ä¸€ç§ <strong>å†…ç½®é”ï¼ˆMonitor é”ï¼‰</strong>ï¼Œç”¨äºä¿è¯çº¿ç¨‹å®‰å…¨ã€‚æ¯ä¸ªå¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºä¸€æŠŠé”ï¼Œå½“çº¿ç¨‹è¿›å…¥ <code>synchronized</code> ä»£ç å—æ—¶ï¼š</p>
<ul>
<li><strong>è‡ªåŠ¨è·å–å¯¹è±¡çš„å†…éƒ¨é”</strong>ï¼Œé˜»æ­¢å…¶ä»–çº¿ç¨‹è¿›å…¥è¯¥åŒæ­¥ä»£ç å—ã€‚</li>
<li>çº¿ç¨‹æ‰§è¡Œå®Œæˆæˆ–å¼‚å¸¸é€€å‡ºæ—¶ï¼Œ<strong>è‡ªåŠ¨é‡Šæ”¾é”</strong>ã€‚</li>
</ul>
<p>ç”±äº Java çº¿ç¨‹ä¸<strong>æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹</strong>ä¸€ä¸€å¯¹åº”ï¼Œ<code>synchronized</code> å¯èƒ½å¯¼è‡´çº¿ç¨‹é˜»å¡ï¼Œè§¦å‘<strong>ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢</strong>ï¼Œå¸¦æ¥é¢å¤–çš„<strong>ä¸Šä¸‹æ–‡åˆ‡æ¢</strong>å¼€é”€ã€‚å› æ­¤ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹éœ€æ…é‡ä½¿ç”¨ã€‚</p>
<h4 id="2-å†…å­˜è¯­ä¹‰"><a href="#2-å†…å­˜è¯­ä¹‰" class="headerlink" title="2. å†…å­˜è¯­ä¹‰"></a>2. <strong>å†…å­˜è¯­ä¹‰</strong></h4><p><code>synchronized</code> æ—¢ä¿è¯<strong>äº’æ–¥æ€§</strong>ï¼ˆåŒä¸€æ—¶åˆ»ä»…ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼‰ï¼Œä¹Ÿä¿è¯<strong>å¯è§æ€§</strong>ï¼ˆç¡®ä¿è¯»å–æœ€æ–°æ•°æ®ï¼‰ã€‚</p>
<ul>
<li><strong>è¿›å…¥ <code>synchronized</code> ä»£ç å—æ—¶</strong>ï¼š<ul>
<li>çº¿ç¨‹ä¼š <strong>æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ¶‰åŠçš„å…±äº«å˜é‡</strong>ï¼Œç¡®ä¿ä»<strong>ä¸»å†…å­˜</strong>è·å–æœ€æ–°æ•°æ®ã€‚</li>
</ul>
</li>
<li><strong>æ‰§è¡Œ <code>synchronized</code> ä»£ç å—</strong>ï¼š<ul>
<li>çº¿ç¨‹ç‹¬å æ‰§è¡Œï¼Œé˜²æ­¢ç«æ€æ¡ä»¶ã€‚</li>
</ul>
</li>
<li><strong>é€€å‡º <code>synchronized</code> ä»£ç å—æ—¶</strong>ï¼š<ul>
<li>çº¿ç¨‹ <strong>å¿…é¡»å°†ä¿®æ”¹çš„å˜é‡åˆ·æ–°å›ä¸»å†…å­˜</strong>ï¼Œç¡®ä¿å…¶ä»–çº¿ç¨‹å¯è§ã€‚</li>
</ul>
</li>
</ul>
<p>è¿™ç§<strong>å†…å­˜è¯­ä¹‰</strong>ç”± <strong>Java å†…å­˜æ¨¡å‹ï¼ˆJVMï¼‰</strong> é€šè¿‡ <strong>å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰</strong> æœºåˆ¶å®ç°ï¼Œä½¿å¾— <code>synchronized</code> å…·å¤‡ <strong>å¯è§æ€§</strong> å’Œ <strong>æœ‰åºæ€§</strong>ã€‚</p>
<h3 id="5-2-volatile"><a href="#5-2-volatile" class="headerlink" title="5.2 volatile"></a>5.2 <code>volatile</code></h3><h4 id="1-ç®€ä»‹-1"><a href="#1-ç®€ä»‹-1" class="headerlink" title="1. ç®€ä»‹"></a>1. <strong>ç®€ä»‹</strong></h4><p><code>synchronized</code> è§£å†³äº†<strong>å…±äº«å˜é‡çš„å¯è§æ€§é—®é¢˜</strong>ï¼Œä½†ç”±äº<strong>çº¿ç¨‹é˜»å¡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢</strong>ï¼Œæ€§èƒ½å¼€é”€è¾ƒå¤§ã€‚Java æä¾›äº† <code>volatile</code> å…³é”®å­—ï¼Œä½œä¸º<strong>æ›´è½»é‡çº§çš„å¯è§æ€§ä¿è¯æœºåˆ¶</strong>ã€‚</p>
<p>å½“å˜é‡è¢«å£°æ˜ä¸º <code>volatile</code> æ—¶ï¼š</p>
<ul>
<li>çº¿ç¨‹ <strong>ä¿®æ”¹å˜é‡æ—¶</strong>ï¼Œä¼š<strong>ç«‹åˆ»åˆ·æ–°åˆ°ä¸»å†…å­˜</strong>ã€‚</li>
<li>å…¶ä»–çº¿ç¨‹ <strong>è¯»å–å˜é‡æ—¶</strong>ï¼Œä¼š<strong>ç›´æ¥ä»ä¸»å†…å­˜è·å–æœ€æ–°å€¼</strong>ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å·¥ä½œå†…å­˜çš„ç¼“å­˜ã€‚</li>
</ul>
<p><strong>æ³¨æ„ï¼š<code>volatile</code> ä¸èƒ½ä¿è¯åŸå­æ€§</strong>ï¼Œå®ƒä»…ç¡®ä¿å˜é‡çš„å¯è§æ€§ã€‚</p>
<h4 id="2-å†…å­˜è¯­ä¹‰-1"><a href="#2-å†…å­˜è¯­ä¹‰-1" class="headerlink" title="2. å†…å­˜è¯­ä¹‰"></a>2. <strong>å†…å­˜è¯­ä¹‰</strong></h4><ul>
<li>å†™å…¥ <code>volatile</code> å˜é‡æ—¶ï¼š<ul>
<li><strong>ä¿®æ”¹å€¼åç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜</strong>ã€‚</li>
</ul>
</li>
<li>è¯»å– <code>volatile</code> å˜é‡æ—¶ï¼š<ul>
<li><strong>å¼ºåˆ¶ä»ä¸»å†…å­˜è·å–æœ€æ–°å€¼</strong>ï¼Œä¸ä½¿ç”¨çº¿ç¨‹çš„æœ¬åœ°ç¼“å­˜ã€‚</li>
</ul>
</li>
</ul>
<h4 id="3-ç¤ºä¾‹å¯¹æ¯”"><a href="#3-ç¤ºä¾‹å¯¹æ¯”" class="headerlink" title="3. ç¤ºä¾‹å¯¹æ¯”"></a>3. <strong>ç¤ºä¾‹å¯¹æ¯”</strong></h4><p>ä»¥ä¸‹æ˜¯ <code>synchronized</code> å’Œ <code>volatile</code> åœ¨å˜é‡åŒæ­¥ä¸­çš„ä½¿ç”¨å¯¹æ¯”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éçº¿ç¨‹å®‰å…¨çš„å…±äº«å˜é‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadNotSafeInteger</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ synchronized è§£å†³å¹¶å‘é—®é¢˜ï¼ˆä¿è¯å¯è§æ€§å’ŒåŸå­æ€§ï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadSafeIntegerBySynchronized</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ volatile è§£å†³å¯è§æ€§é—®é¢˜ï¼ˆä½†ä¸ä¿è¯åŸå­æ€§ï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadSafeIntegerByVolatile</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å¯¹æ¯”åˆ†æï¼š</strong></p>
<ul>
<li><strong><code>synchronized</code></strong>ï¼šä¿è¯<strong>åŸå­æ€§ + å¯è§æ€§</strong>ï¼Œä½†å¼€é”€è¾ƒå¤§ã€‚</li>
<li><strong><code>volatile</code></strong>ï¼šä»…ä¿è¯<strong>å¯è§æ€§</strong>ï¼Œä¸é€‚ç”¨äº<strong>å¤åˆæ“ä½œ</strong>ï¼ˆå¦‚ <code>i++</code> ä»ç„¶å¯èƒ½å‡ºç°ç«æ€æ¡ä»¶ï¼‰ã€‚</li>
</ul>
<h3 id="5-3-é€‚ç”¨åœºæ™¯"><a href="#5-3-é€‚ç”¨åœºæ™¯" class="headerlink" title="5.3 é€‚ç”¨åœºæ™¯"></a>5.3 é€‚ç”¨åœºæ™¯</h3><ul>
<li><strong>ä½¿ç”¨ <code>volatile</code></strong>ï¼š<ul>
<li>çŠ¶æ€æ ‡å¿—ï¼ˆå¦‚ <code>boolean isRunning</code>ï¼‰</li>
<li>è½»é‡çº§çš„å˜é‡åŒæ­¥ï¼ˆä¸æ¶‰åŠå¤åˆæ“ä½œï¼‰</li>
</ul>
</li>
<li><strong>ä½¿ç”¨ <code>synchronized</code></strong>ï¼š<ul>
<li>éœ€è¦<strong>äº’æ–¥è®¿é—®</strong>çš„åœºæ™¯</li>
<li>å¤åˆæ“ä½œï¼ˆå¦‚ <code>i++</code>ã€<code>a = b + c</code>ï¼‰</li>
<li>éœ€è¦<strong>ä¿è¯åŸå­æ€§å’Œå¯è§æ€§</strong>çš„å¤æ‚ä¸šåŠ¡é€»è¾‘</li>
</ul>
</li>
</ul>
<h2 id="6-Javaä¸­çš„åŸå­æ€§æ“ä½œ"><a href="#6-Javaä¸­çš„åŸå­æ€§æ“ä½œ" class="headerlink" title="6. Javaä¸­çš„åŸå­æ€§æ“ä½œ"></a>6. Javaä¸­çš„åŸå­æ€§æ“ä½œ</h2><p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œ<strong>åŸå­æ€§</strong>æŒ‡çš„æ˜¯ä¸€ç³»åˆ—æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å¹²æ‰°ã€‚</p>
<p><strong>çº¿ç¨‹å®‰å…¨é—®é¢˜</strong></p>
<p>è®¡æ•°å™¨æ“ä½œé€šå¸¸æ¶‰åŠ <strong>å…ˆè¯»å–å½“å‰å€¼ï¼Œå†é€’å¢</strong>ï¼Œå¦‚æœæ— æ³•ä¿è¯è¯¥è¿‡ç¨‹çš„åŸå­æ€§ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½ä¼šå¯¼è‡´<strong>çº¿ç¨‹å®‰å…¨é—®é¢˜</strong>ã€‚</p>
<p><strong>ç¤ºä¾‹å¯¹æ¯”ï¼šçº¿ç¨‹ä¸å®‰å…¨ vs. çº¿ç¨‹å®‰å…¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadNotSafeCount</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        value++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadSafeCount</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> Long <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        value++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>synchronized</code> èƒ½ç¡®ä¿<strong>åŸå­æ€§</strong>å’Œ<strong>å¯è§æ€§</strong>ï¼Œä½†å®ƒæ˜¯ <strong>æ’å®ƒé”</strong>ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—® <code>value</code> æ—¶ï¼Œå…¶ä»–çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡ï¼Œå°¤å…¶æ˜¯<strong>è¯»æ“ä½œ</strong>ä¹ŸåŠ é”ï¼Œä¼šå½±å“æ€§èƒ½ã€‚å¦‚æœå»æ‰ <code>synchronized</code> åªå¯¹ <code>getValue()</code> è§£é”ï¼Œä»ç„¶ä¼šå¯¼è‡´<strong>æ•°æ®å¯è§æ€§é—®é¢˜ï¼ˆè„è¯»ï¼‰</strong>ã€‚</p>
<p>æ›´å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ <code>AtomicLong</code>ï¼Œå®ƒåŸºäº CASï¼ˆCompare-And-Swapï¼‰ç®—æ³•ï¼Œèƒ½é«˜æ•ˆä¿è¯åŸå­æ€§ã€‚</p>
<h2 id="7-Javaä¸­çš„CASæ“ä½œ"><a href="#7-Javaä¸­çš„CASæ“ä½œ" class="headerlink" title="7. Javaä¸­çš„CASæ“ä½œ"></a>7. Javaä¸­çš„CASæ“ä½œ</h2><p>åœ¨ä½¿ç”¨é”æ—¶ï¼Œçº¿ç¨‹å¯èƒ½ä¼šå‘ç”Ÿé˜»å¡ï¼Œé¢‘ç¹è¿›è¡Œ<strong>ä¸Šä¸‹æ–‡åˆ‡æ¢</strong>å’Œ<strong>çº¿ç¨‹è°ƒåº¦</strong>ï¼Œä»è€Œå¢åŠ ç³»ç»Ÿå¼€é”€ã€‚</p>
<p><code>volatile</code> å…³é”®å­—<strong>ä»…ä¿è¯å¯è§æ€§</strong>ï¼Œä½†<strong>æ— æ³•ç¡®ä¿æ“ä½œçš„åŸå­æ€§</strong>ã€‚</p>
<p><strong>CASï¼ˆCompare-And-Swapï¼‰</strong> æ˜¯ JDK æä¾›çš„ä¸€ç§<strong>éé˜»å¡åŸå­æ“ä½œ</strong>ï¼Œé€šè¿‡<strong>ç¡¬ä»¶çº§åˆ«çš„æ”¯æŒ</strong>ç¡®ä¿<strong>æ¯”è¾ƒ-æ›´æ–°æ“ä½œçš„åŸå­æ€§</strong>ã€‚<code>Unsafe</code> ç±»æä¾›äº†ä¸€ç³»åˆ— CAS ç›¸å…³çš„ APIï¼Œä»¥å®ç°é«˜æ•ˆçš„å¹¶å‘æ§åˆ¶ã€‚</p>
<h3 id="7-1-Unsafeç±»"><a href="#7-1-Unsafeç±»" class="headerlink" title="7.1  Unsafeç±»"></a>7.1  Unsafeç±»</h3><p><code>Unsafe</code> æ˜¯ Java æä¾›çš„ä¸€ä¸ª<strong>ä½çº§ API</strong>ï¼Œç”¨äºç›´æ¥æ“ä½œå†…å­˜ã€å¯¹è±¡å®ä¾‹åŒ–ã€CAS æ“ä½œç­‰ï¼Œé€šå¸¸ç”¨äºé«˜æ€§èƒ½å¹¶å‘å·¥å…·ï¼ˆå¦‚ <code>AtomicInteger</code>ï¼‰ã€åºåˆ—åŒ–æ¡†æ¶ï¼ˆå¦‚ <code>Kryo</code>ï¼‰ç­‰ã€‚</p>
<ul>
<li><strong>éå®‰å…¨</strong>ï¼š<code>Unsafe</code> å…è®¸ç»•è¿‡ Java è¯­è¨€å±‚é¢æä¾›çš„å®‰å…¨æœºåˆ¶ï¼Œç›´æ¥æ“ä½œå†…å­˜ï¼Œå®¹æ˜“å¯¼è‡´ JVM å´©æºƒæˆ–å†…å­˜æ³„æ¼ã€‚</li>
<li><strong>ç§æœ‰åŒ–æ„é€ </strong>ï¼š<code>Unsafe</code> çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œæ— æ³•é€šè¿‡ <code>new</code> ç›´æ¥å®ä¾‹åŒ–ã€‚</li>
<li><strong>è·å–æ–¹å¼</strong>ï¼šå¯ä»¥é€šè¿‡åå°„è·å– <code>Unsafe</code> å®ä¾‹ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (Unsafe) field.get(<span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="7-2-å…³é”®API"><a href="#7-2-å…³é”®API" class="headerlink" title="7.2 å…³é”®API"></a>7.2 å…³é”®API</h3><h4 id="7-2-1-å†…å­˜æ“ä½œ"><a href="#7-2-1-å†…å­˜æ“ä½œ" class="headerlink" title="7.2.1 å†…å­˜æ“ä½œ"></a>7.2.1 å†…å­˜æ“ä½œ</h4><p><code>Unsafe</code> æä¾›äº†ç›´æ¥æ“ä½œå†…å­˜çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬åˆ†é…ã€é‡Šæ”¾ã€è¯»å†™ç­‰ã€‚</p>
<ol>
<li><p><strong>ç›´æ¥åˆ†é… &#x2F; é‡Šæ”¾å†…å­˜</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">address</span> <span class="operator">=</span> unsafe.allocateMemory(<span class="number">1024</span>); <span class="comment">// åˆ†é… 1024 å­—èŠ‚å†…å­˜</span></span><br><span class="line">unsafe.freeMemory(address); <span class="comment">// é‡Šæ”¾å†…å­˜</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>å†…å­˜å†™å…¥ &#x2F; è¯»å–</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsafe.putInt(address, <span class="number">100</span>); <span class="comment">// åœ¨æŒ‡å®šåœ°å€å†™å…¥ 100</span></span><br><span class="line"><span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> unsafe.getInt(address); <span class="comment">// è¯»å–è¯¥åœ°å€çš„å€¼</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="7-2-2-å¯¹è±¡æ“ä½œ"><a href="#7-2-2-å¯¹è±¡æ“ä½œ" class="headerlink" title="7.2.2 å¯¹è±¡æ“ä½œ"></a>7.2.2 <strong>å¯¹è±¡æ“ä½œ</strong></h4><p>å…è®¸åœ¨ä¸è°ƒç”¨æ„é€ æ–¹æ³•çš„æƒ…å†µä¸‹åˆ›å»ºå¯¹è±¡(åºåˆ—åŒ–æ¡†æ¶)</p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) unsafe.allocateInstance(User.class);</span><br></pre></td></tr></table></figure>

<h4 id="7-2-3-å¯¹è±¡å­—æ®µæ“ä½œ"><a href="#7-2-3-å¯¹è±¡å­—æ®µæ“ä½œ" class="headerlink" title="7.2.3 å¯¹è±¡å­—æ®µæ“ä½œ"></a>7.2.3 <strong>å¯¹è±¡å­—æ®µæ“ä½œ</strong></h4><ol>
<li><p><strong>è·å–å­—æ®µåç§»é‡</strong></p>
<p><code>objectFieldOffset</code> è¿”å›å­—æ®µåœ¨å¯¹è±¡ä¸­çš„å†…å­˜åç§»é‡ï¼Œç”¨äº <code>Unsafe</code> ç›´æ¥è®¿é—®å­—æ®µã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> User.class.getDeclaredField(<span class="string">&quot;age&quot;</span>);</span><br><span class="line"><span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> unsafe.objectFieldOffset(field);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ç›´æ¥æ“ä½œå­—æ®µå€¼</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">unsafe.putInt(user, offset, <span class="number">25</span>); <span class="comment">// ç›´æ¥ä¿®æ”¹ user.age = 25</span></span><br><span class="line"><span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> unsafe.getInt(user, offset); <span class="comment">// è¯»å– age</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="7-2-4-CASæ“ä½œ"><a href="#7-2-4-CASæ“ä½œ" class="headerlink" title="7.2.4 CASæ“ä½œ"></a>7.2.4 <strong>CASæ“ä½œ</strong></h4><p>CAS æ˜¯æ— é”å¹¶å‘çš„åŸºç¡€ï¼Œ<code>Unsafe</code> æä¾›äº†åº•å±‚æ”¯æŒ, CAS å¸¸ç”¨äº <code>AtomicInteger</code> ç­‰ç±»æ¥å®ç°<strong>æ— é”åŸå­æ“ä½œ</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> unsafe.compareAndSwapInt(user, offset, <span class="number">25</span>, <span class="number">30</span>); <span class="comment">// æœŸæœ›å€¼25ï¼Œä¿®æ”¹ä¸º30</span></span><br></pre></td></tr></table></figure>

<h4 id="7-2-5-æ•°ç»„æ“ä½œ"><a href="#7-2-5-æ•°ç»„æ“ä½œ" class="headerlink" title="7.2.5 æ•°ç»„æ“ä½œ"></a>7.2.5 <strong>æ•°ç»„æ“ä½œ</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">baseOffset</span> <span class="operator">=</span> unsafe.arrayBaseOffset(<span class="type">int</span>[].class); <span class="comment">// è·å–æ•°ç»„èµ·å§‹åœ°å€</span></span><br><span class="line"><span class="type">int</span> <span class="variable">indexScale</span> <span class="operator">=</span> unsafe.arrayIndexScale(<span class="type">int</span>[].class); <span class="comment">// è·å–æ•°ç»„å…ƒç´ å¤§å°ï¼ˆæ­¥é•¿ï¼‰</span></span><br></pre></td></tr></table></figure>

<h4 id="7-2-6-çº¿ç¨‹æ“ä½œ"><a href="#7-2-6-çº¿ç¨‹æ“ä½œ" class="headerlink" title="7.2.6 çº¿ç¨‹æ“ä½œ"></a>7.2.6 <strong>çº¿ç¨‹æ“ä½œ</strong></h4><p>æŒ‚èµ·å’Œæ¢å¤çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsafe.park(<span class="literal">false</span>, <span class="number">0</span>); <span class="comment">// æŒ‚èµ·å½“å‰çº¿ç¨‹</span></span><br><span class="line">unsafe.unpark(Thread.currentThread()); <span class="comment">// æ¢å¤çº¿ç¨‹</span></span><br></pre></td></tr></table></figure>





<h3 id="7-3-ç»¼åˆæ¡ˆä¾‹"><a href="#7-3-ç»¼åˆæ¡ˆä¾‹" class="headerlink" title="7.3 ç»¼åˆæ¡ˆä¾‹"></a>7.3 ç»¼åˆæ¡ˆä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Unsafe å†…éƒ¨æ„é€ å™¨ç§æœ‰, ä¸èƒ½new, å¯ä»¥é€šè¿‡åå°„theUnsafeè·å–</span></span><br><span class="line"><span class="comment">// è¯¥æ¥å£æä¾›äº†å¾ˆå¤šæ“ä½œå†…å­˜ çº¿ç¨‹ cpuçš„åº•å±‚API, ç§æœ‰è¾ƒä¸ºå®‰å…¨é˜²æ­¢è¢«è¯¯ç”¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Unsafe unsafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Target</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// å®ä¾‹åç§°å°±å«theUnsafe</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    unsafe = (Unsafe) field.get(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testObjectField</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Target</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Target</span>();</span><br><span class="line">    <span class="comment">// unSafe é€šè¿‡å†…å­˜åç§»é‡è®¿é—®å­—æ®µ, ç»•è¿‡äº† Javaçš„è®¿é—®æ§åˆ¶æœºåˆ¶, ç›´æ¥ä¿®æ”¹ä¸»å†…å­˜æ•°æ®, å¹¶éå·¥ä½œå†…ç¨‹æ•°æ®</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Target.class.getDeclaredField(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> unsafe.objectFieldOffset(field);</span><br><span class="line">    assertEquals(<span class="number">10</span>, unsafe.getInt(target, offset));</span><br><span class="line">    unsafe.putInt(target, offset, <span class="number">20</span>);</span><br><span class="line">    assertEquals(<span class="number">20</span>, unsafe.getInt(target, offset));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testArrayOperations</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span>[] array = <span class="keyword">new</span> <span class="title class_">int</span>[] &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line">    <span class="type">int</span> <span class="variable">baseOffset</span> <span class="operator">=</span> unsafe.arrayBaseOffset(<span class="type">int</span>[].class);</span><br><span class="line">    <span class="type">int</span> <span class="variable">indexScale</span> <span class="operator">=</span> unsafe.arrayIndexScale(<span class="type">int</span>[].class);</span><br><span class="line"></span><br><span class="line">    assertEquals(<span class="number">16</span>, baseOffset); <span class="comment">// JVM é»˜è®¤å€¼ï¼Œå¯èƒ½å› ç¯å¢ƒå˜åŒ–</span></span><br><span class="line">    assertEquals(<span class="number">4</span>, indexScale); <span class="comment">// int å  4 å­—èŠ‚</span></span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">index1Address</span> <span class="operator">=</span> baseOffset + indexScale;</span><br><span class="line">    assertEquals(<span class="number">2</span>, unsafe.getInt(array, index1Address));</span><br><span class="line">    unsafe.putInt(array, index1Address, <span class="number">100</span>);</span><br><span class="line">    assertEquals(<span class="number">100</span>, array[<span class="number">1</span>]); <span class="comment">// ä¿®æ”¹æˆåŠŸ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCASOperation</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException &#123;</span><br><span class="line">    <span class="comment">// CASæœºåˆ¶ä»ç¡¬ä»¶å±‚é¢ä¿è¯äº†åŸå­æ€§æ“ä½œ</span></span><br><span class="line">    <span class="type">Target</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Target</span>();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Target.class.getDeclaredField(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> unsafe.objectFieldOffset(field);</span><br><span class="line"></span><br><span class="line">    assertTrue(unsafe.compareAndSwapInt(target, offset, <span class="number">10</span>, <span class="number">50</span>)); <span class="comment">// CAS æˆåŠŸ</span></span><br><span class="line">    assertEquals(<span class="number">50</span>, unsafe.getInt(target, offset)); <span class="comment">// å€¼å·²å˜æ›´</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testOperation</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException &#123;</span><br><span class="line">    <span class="comment">// è¿™ç§æ–¹å¼è¯»å†™æ“ä½œå¹¶éåŸå­æ€§æ“ä½œ, å¯èƒ½ä¼šå¯¼è‡´æ›´æ–°æ¶ˆå¤± </span></span><br><span class="line">    <span class="type">Target</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Target</span>();</span><br><span class="line">    <span class="comment">// å…ˆè¯»æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (target.getValue() == <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="comment">// å†å†™æ“ä½œ</span></span><br><span class="line">        target.setValue(<span class="number">50</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="8-Java-æŒ‡ä»¤é‡æ’åº"><a href="#8-Java-æŒ‡ä»¤é‡æ’åº" class="headerlink" title="8. Java æŒ‡ä»¤é‡æ’åº"></a>8. Java æŒ‡ä»¤é‡æ’åº</h2><p>Javaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰å…è®¸ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œä»¥æé«˜è¿è¡Œæ€§èƒ½ã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šæ ¹å¯¹æ²¡æœ‰æ•°æ®ä¾èµ–çš„æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œä»¥ä¼˜åŒ–ä»£ç æ‰§è¡Œçš„æ•ˆç‡ã€‚åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸­ï¼Œè¿™ç§ä¼˜åŒ–é€šå¸¸ä¸ä¼šå¼•å‘é—®é¢˜ï¼Œä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œç”±äºçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºä¸å¯é¢„æµ‹ï¼ŒæŒ‡ä»¤é‡æ’åºå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´æˆ–ä¸å¯é¢„æ–™çš„ç»“æœã€‚</p>
<p><strong>ç¤ºä¾‹</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">volatileFlag</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// ä½¿ç”¨volatileç¡®ä¿å¯è§æ€§</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// å…±äº«å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUnSafe</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">threadA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// çº¿ç¨‹Aä¿®æ”¹å…±äº«å˜é‡</span></span><br><span class="line">        value = <span class="number">42</span>;  <span class="comment">// æŒ‡ä»¤1</span></span><br><span class="line">        flag = <span class="literal">true</span>;  <span class="comment">// æŒ‡ä»¤2</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">threadB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// çº¿ç¨‹Bè¯»å–å…±äº«å˜é‡</span></span><br><span class="line">        <span class="keyword">if</span> (flag) &#123; <span class="comment">// æŒ‡ä»¤3</span></span><br><span class="line">            System.out.println(<span class="string">&quot;value: &quot;</span> + value); <span class="comment">// æŒ‡ä»¤4</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// æŒ‡ä»¤é‡æ’åºå¯¼è‡´ æ‰“å°ç»“æœä¸ä¸€è‡´ </span></span><br><span class="line">    threadA.start();</span><br><span class="line">    threadB.start();</span><br><span class="line">    threadA.join();</span><br><span class="line">    threadB.join();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSafe</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">threadA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// çº¿ç¨‹Aä¿®æ”¹å…±äº«å˜é‡</span></span><br><span class="line">        value = <span class="number">42</span>;  <span class="comment">// æŒ‡ä»¤1</span></span><br><span class="line">        volatileFlag = <span class="literal">true</span>;  <span class="comment">// æŒ‡ä»¤2</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">threadB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// çº¿ç¨‹Bè¯»å–å…±äº«å˜é‡</span></span><br><span class="line">        <span class="keyword">if</span> (volatileFlag) &#123; <span class="comment">// æŒ‡ä»¤3</span></span><br><span class="line">            System.out.println(<span class="string">&quot;value: &quot;</span> + value); <span class="comment">// æŒ‡ä»¤4</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨volatileå…³é”®å­—, ä¿è¯å˜é‡çš„ä¿®æ”¹å¯¹çº¿ç¨‹å¯è§</span></span><br><span class="line">    threadA.start();</span><br><span class="line">    threadB.start();</span><br><span class="line">    threadA.join();</span><br><span class="line">    threadB.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>volatile</code> çš„ä½œç”¨</p>
<ul>
<li><strong>å†™æ“ä½œï¼š</strong> å†™å…¥<code>volatile</code>å˜é‡æ—¶ï¼Œç¡®ä¿å†™å…¥æ“ä½œå‰çš„æ‰€æœ‰æŒ‡ä»¤ä¸ä¼šè¢«é‡æ’åºåˆ°å†™æ“ä½œä¹‹åã€‚å³ï¼Œ<code>value = 42</code>ä¸ä¼šè¢«é‡æ’åºåˆ°<code>volatileFlag = true</code>ä¹‹åã€‚</li>
<li><strong>è¯»æ“ä½œï¼š</strong> è¯»<code>volatile</code>å˜é‡æ—¶ï¼Œç¡®ä¿è¯»æ“ä½œåé¢çš„æ‰€æœ‰æŒ‡ä»¤ä¸ä¼šè¢«é‡æ’åºåˆ°è¯»å–æ“ä½œä¹‹å‰ã€‚å³ï¼Œçº¿ç¨‹Båœ¨è¯»å–åˆ°<code>volatileFlag</code>æ—¶ï¼Œå®ƒåé¢çš„<code>value</code>è¯»å–æ“ä½œå°†ç¡®ä¿è¯»å–åˆ°æœ€æ–°å€¼ã€‚</li>
</ul>
<p>é€šè¿‡ä½¿ç”¨<code>volatile</code>ï¼Œå¯ä»¥ç¡®ä¿å˜é‡çš„æ›´æ–°åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å¯è§ï¼Œä»è€Œé¿å…äº†ç”±äºæŒ‡ä»¤é‡æ’åºå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</p>
<h2 id="9-ä¼ªå…±äº«"><a href="#9-ä¼ªå…±äº«" class="headerlink" title="9. ä¼ªå…±äº«"></a>9. ä¼ªå…±äº«</h2><p>ä¼ªå…±äº«ï¼ˆFalse Sharingï¼‰æ˜¯ç”±äºå¤šçº¿ç¨‹å¹¶å‘è®¿é—®ä¸åŒå˜é‡æ—¶ï¼Œå®ƒä»¬æ„å¤–åœ°ä½äºåŒä¸€ä¸ªCPUç¼“å­˜è¡Œå†…ï¼Œå¯¼è‡´ç¼“å­˜åŒæ­¥äº§ç”Ÿæ€§èƒ½ä¸‹é™çš„ä¸€ç§ç°è±¡ã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£ä¼ªå…±äº«ï¼Œæˆ‘ä»¬å¯ä»¥ä»è®¡ç®—æœºå†…å­˜ç¼“å­˜æ¨¡å‹çš„è§’åº¦æ¥åˆ†æã€‚</p>
<h3 id="9-1-å†…å­˜ç¼“å­˜æ¨¡å‹"><a href="#9-1-å†…å­˜ç¼“å­˜æ¨¡å‹" class="headerlink" title="9.1 å†…å­˜ç¼“å­˜æ¨¡å‹"></a>9.1 å†…å­˜ç¼“å­˜æ¨¡å‹</h3><p>ç°ä»£è®¡ç®—æœºé€šå¸¸é‡‡ç”¨<strong>å¤šçº§ç¼“å­˜</strong>æ¶æ„ï¼ŒåŒ…æ‹¬L1ç¼“å­˜ã€L2ç¼“å­˜ç­‰ï¼Œå®ƒä»¬ä½äºCPUå†…éƒ¨ï¼Œè·ç¦»CPUè®¡ç®—å•å…ƒéå¸¸è¿‘ï¼Œå¯ä»¥æå¤§åœ°æé«˜è®¿é—®é€Ÿåº¦ã€‚ä¸ºäº†å¼¥è¡¥CPUä¸ä¸»å†…å­˜ä¹‹é—´çš„é€Ÿåº¦å·®å¼‚ï¼ŒCPUä¼šå…ˆåœ¨ç¼“å­˜ï¼ˆCacheï¼‰ä¸­æŸ¥æ‰¾éœ€è¦çš„æ•°æ®ï¼Œåªæœ‰å½“æ•°æ®ä¸åœ¨ç¼“å­˜ä¸­æ—¶ï¼Œæ‰ä¼šä»ä¸»å†…å­˜åŠ è½½ã€‚</p>
<h3 id="9-2-ç¼“å­˜è¡Œ"><a href="#9-2-ç¼“å­˜è¡Œ" class="headerlink" title="9.2 ç¼“å­˜è¡Œ"></a>9.2 ç¼“å­˜è¡Œ</h3><ul>
<li><strong>ç¼“å­˜è¡Œ</strong>æ˜¯CPUç¼“å­˜ä¸­çš„åŸºæœ¬å­˜å‚¨å•ä½ï¼Œé€šå¸¸æ¯ä¸ªç¼“å­˜è¡Œå¤§å°ä¸º64å­—èŠ‚ï¼ˆä¸åŒæ¶æ„å¯èƒ½æœ‰æ‰€ä¸åŒï¼‰ã€‚</li>
<li>å½“CPUè®¿é—®å†…å­˜ä¸­çš„æŸä¸ªå˜é‡æ—¶ï¼Œå®ƒå¹¶ä¸æ˜¯å•ç‹¬åŠ è½½è¯¥å˜é‡ï¼Œè€Œæ˜¯æŠŠå˜é‡æ‰€åœ¨çš„ç¼“å­˜è¡Œï¼ˆåŒ…å«è¯¥å˜é‡çš„64å­—èŠ‚å†…å­˜åŒºåŸŸï¼‰åŠ è½½åˆ°CPUç¼“å­˜ä¸­ã€‚</li>
<li>ä¸€ä¸ªç¼“å­˜è¡Œå¯èƒ½åŒ…å«å¤šä¸ªå˜é‡ã€‚</li>
</ul>
<h3 id="9-3-ç¼“å­˜ä¸€è‡´æ€§åè®®"><a href="#9-3-ç¼“å­˜ä¸€è‡´æ€§åè®®" class="headerlink" title="9.3 ç¼“å­˜ä¸€è‡´æ€§åè®®"></a>9.3 ç¼“å­˜ä¸€è‡´æ€§åè®®</h3><p>ç”±äºç°ä»£è®¡ç®—æœºæ˜¯å¤šæ ¸çš„ï¼Œæ¯ä¸ªæ ¸å¿ƒé€šå¸¸æœ‰è‡ªå·±çš„L1å’ŒL2ç¼“å­˜ï¼Œè¿™å°±å¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼šä¸åŒæ ¸å¿ƒçš„ç¼“å­˜ä¸­çš„æ•°æ®å¯èƒ½ä¼šä¸ä¸€è‡´ã€‚ä¸ºäº†ä¿è¯å¤šä¸ªæ ¸å¿ƒä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼ŒCPUä¼šé€šè¿‡<strong>ç¼“å­˜ä¸€è‡´æ€§åè®®</strong>ï¼ˆå¦‚MESIåè®®ï¼‰æ¥åè°ƒç¼“å­˜çš„æ›´æ–°ã€‚</p>
<h3 id="9-4-ä¼ªå…±äº«å¦‚ä½•å‘ç”Ÿçš„"><a href="#9-4-ä¼ªå…±äº«å¦‚ä½•å‘ç”Ÿçš„" class="headerlink" title="9.4 ä¼ªå…±äº«å¦‚ä½•å‘ç”Ÿçš„?"></a>9.4 ä¼ªå…±äº«å¦‚ä½•å‘ç”Ÿçš„?</h3><p>ä¼ªå…±äº«å‘ç”Ÿçš„æ ¹æœ¬åŸå› æ˜¯<strong>å¤šä¸ªçº¿ç¨‹å¯¹ä¸åŒå˜é‡çš„ä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´è¿™äº›å˜é‡ä½äºåŒä¸€ä¸ªç¼“å­˜è¡Œä¸­</strong>ã€‚å³ä½¿è¿™äº›å˜é‡æ²¡æœ‰æ•°æ®ä¾èµ–æ€§ï¼Œä½†ç”±äºåŒä¸€ä¸ªç¼“å­˜è¡Œåªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹ï¼Œå¯¼è‡´å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹ä¸åŒå˜é‡æ—¶ï¼Œå¿…é¡»é¢‘ç¹åœ°åŒæ­¥ç¼“å­˜è¡Œã€‚è¿™ç§åŒæ­¥å¸¦æ¥äº†ä¸å¿…è¦çš„æ€§èƒ½æŸå¤±ã€‚</p>
<h3 id="9-5-ä¼ªå…±äº«çš„å·¥ä½œè¿‡ç¨‹"><a href="#9-5-ä¼ªå…±äº«çš„å·¥ä½œè¿‡ç¨‹" class="headerlink" title="9.5 ä¼ªå…±äº«çš„å·¥ä½œè¿‡ç¨‹"></a>9.5 ä¼ªå…±äº«çš„å·¥ä½œè¿‡ç¨‹</h3><ol>
<li><p><strong>ç¼“å­˜è¡Œçš„å…±äº«ï¼š</strong> å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹1ä¿®æ”¹å˜é‡<code>x</code>ï¼Œçº¿ç¨‹2ä¿®æ”¹å˜é‡<code>y</code>ï¼Œä¸”<code>x</code>å’Œ<code>y</code>ä½äºå†…å­˜ä¸­çš„ç›¸é‚»ä½ç½®ï¼Œå¯èƒ½ä¼šè¢«åŠ è½½åˆ°åŒä¸€ä¸ªç¼“å­˜è¡Œä¸­ã€‚</p>
</li>
<li><p><strong>ç¼“å­˜è¡ŒåŒæ­¥ï¼š</strong> å½“çº¿ç¨‹1ä¿®æ”¹<code>x</code>æ—¶ï¼Œå®ƒä¼šæ›´æ–°ç¼“å­˜è¡Œä¸­çš„æ•°æ®ï¼Œå¹¶å°†æ›´æ–°åçš„ç¼“å­˜è¡Œæ ‡è®°ä¸ºâ€œè„â€çŠ¶æ€ã€‚çº¿ç¨‹2å¦‚æœä¿®æ”¹<code>y</code>ï¼Œåˆ™ä¼šå¯¼è‡´ç¼“å­˜è¡ŒåŒæ­¥ï¼Œå› ä¸º<code>x</code>å’Œ<code>y</code>å±äºåŒä¸€ä¸ªç¼“å­˜è¡Œã€‚å³ä½¿<code>x</code>å’Œ<code>y</code>ä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ–æ€§ï¼ŒCPUä»ç„¶éœ€è¦åŒæ­¥ç¼“å­˜è¡Œçš„çŠ¶æ€ã€‚</p>
</li>
<li><p><strong>æ€§èƒ½å½±å“ï¼š</strong> ç”±äºç¼“å­˜è¡ŒåŒæ­¥éœ€è¦é¢‘ç¹åœ°ä¸å…¶ä»–æ ¸å¿ƒçš„ç¼“å­˜è¿›è¡Œåè°ƒï¼Œå¯¼è‡´ç¼“å­˜è¡Œçš„åŒæ­¥æˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚å¤šä¸ªçº¿ç¨‹è™½ç„¶åœ¨æ“ä½œä¸åŒå˜é‡ï¼Œä½†ç”±äºè¿™äº›å˜é‡ä½äºåŒä¸€ä¸ªç¼“å­˜è¡Œä¸­ï¼Œå®ƒä»¬çš„è®¿é—®ä¼šå¯¼è‡´ä¸å¿…è¦çš„åŒæ­¥å¼€é”€ï¼Œä»è€Œé™ä½æ•´ä½“æ€§èƒ½ã€‚</p>
</li>
</ol>
<p><a href="/..%5Cimg%5Cjuc%5C05.jpg" class="gallery-item" style="box-shadow: none;"> <img src="/..%5Cimg%5Cjuc%5C05.jpg"></a></p>
<h3 id="9-6-å¦‚ä½•é¿å…ä¼ªå…±äº«"><a href="#9-6-å¦‚ä½•é¿å…ä¼ªå…±äº«" class="headerlink" title="9.6 å¦‚ä½•é¿å…ä¼ªå…±äº«?"></a>9.6 å¦‚ä½•é¿å…ä¼ªå…±äº«?</h3><ol>
<li><p><strong>è°ƒæ•´å˜é‡å¸ƒå±€ï¼š</strong> é€šè¿‡è°ƒæ•´å†…å­˜å¸ƒå±€ï¼Œç¡®ä¿ä¸åŒå˜é‡ä½äºä¸åŒçš„ç¼“å­˜è¡Œä¸­ã€‚å¯ä»¥é€šè¿‡åœ¨å˜é‡ä¹‹é—´æ’å…¥ç©ºç™½å­—æ®µæ¥å¡«å……å†…å­˜ï¼Œè¿™æ ·å°±èƒ½ç¡®ä¿å˜é‡ä¸ä¼šå¤„äºåŒä¸€ä¸ªç¼“å­˜è¡Œå†…ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDataVoidFlaseSharing</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// å¡«å……å†…å­˜ï¼Œç¡®ä¿xå’Œyä¸åœ¨åŒä¸€ä¸ªç¼“å­˜è¡Œ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> padding1, padding2, padding3, padding4, padding5, padding6;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ä½¿ç”¨<code>@Contended</code>æ³¨è§£ï¼ˆJVMç‰¹æ€§ï¼‰ï¼š</strong> åœ¨Javaä¸­ï¼Œå¯ä»¥ä½¿ç”¨<code>@Contended</code>æ³¨è§£æ¥è®©JVMè‡ªåŠ¨ç¡®ä¿å¤šä¸ªå­—æ®µä¸å…±äº«åŒä¸€ä¸ªç¼“å­˜è¡Œï¼ˆéœ€è¦é…åˆJVMé€‰é¡¹<code>-XX:-RestrictContended</code>ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDataVoidFlaseSharingContended</span> &#123;</span><br><span class="line">    <span class="meta">@Contended</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    <span class="meta">@Contended</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="10-é”"><a href="#10-é”" class="headerlink" title="10. é”"></a>10. é”</h2><h3 id="10-1-ä¹è§‚é”ä¸æ‚²è§‚é”"><a href="#10-1-ä¹è§‚é”ä¸æ‚²è§‚é”" class="headerlink" title="10.1 ä¹è§‚é”ä¸æ‚²è§‚é”"></a>10.1 ä¹è§‚é”ä¸æ‚²è§‚é”</h3><h4 id="10-1-1-æ‚²è§‚é”"><a href="#10-1-1-æ‚²è§‚é”" class="headerlink" title="10.1.1 æ‚²è§‚é”"></a>10.1.1 æ‚²è§‚é”</h4><p>æ‚²è§‚é”çš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>è®¤ä¸ºæ•°æ®å¾ˆå®¹æ˜“è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹</strong>ï¼Œå› æ­¤åœ¨<strong>æ•°æ®å¤„ç†å‰å…ˆåŠ é”</strong>ï¼Œç¡®ä¿æ•´ä¸ªå¤„ç†è¿‡ç¨‹ä¸­æ•°æ®ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ã€‚æ‚²è§‚é”é€šå¸¸ä¾èµ–<strong>æ•°æ®åº“çš„é”æœºåˆ¶</strong>æ¥å®ç°ï¼Œä¾‹å¦‚ <strong><code>SELECT ... FOR UPDATE</code></strong> è¯­å¥ã€‚</p>
<p><strong>ç¤ºä¾‹ä»£ç </strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateEntry</span><span class="params">(<span class="type">long</span> id)</span>&#123;</span><br><span class="line"><span class="comment">//(1)ä½¿ç”¨æ‚²è§‚é”è·å–æŒ‡å®šè®°å½•</span></span><br><span class="line"><span class="type">EntryObject</span> <span class="variable">entry</span> <span class="operator">=</span> query(<span class="string">&quot;select * from table1 where id = #&#123;id&#125; for</span></span><br><span class="line"><span class="string">update&quot;</span>,id);</span><br><span class="line"><span class="comment">//(2)ä¿®æ”¹è®°å½•å†…å®¹ï¼Œæ ¹æ®è®¡ç®—ä¿®æ”¹entryè®°å½•çš„å±æ€§</span></span><br><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> generatorName(entry);</span><br><span class="line">entry.setName(name);</span><br><span class="line">â€¦â€¦</span><br><span class="line"><span class="comment">//(3)updateæ“ä½œ</span></span><br><span class="line"><span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> update(<span class="string">&quot;update table1 set name=#&#123;name&#125;,age=#&#123;age&#125; where id</span></span><br><span class="line"><span class="string">=#&#123;id&#125;&quot;</span>,entry);</span><br><span class="line"><span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>äº‹åŠ¡æäº¤æ—¶æœº</strong></p>
<p>å½“äº‹åŠ¡ä¼ æ’­æœºåˆ¶ä¸º <strong><code>REQUIRED</code></strong> æ—¶ï¼Œæ–¹æ³• <code>updateEntry()</code> ä¸­çš„ <strong>æŸ¥è¯¢ (<code>query</code>) å’Œæ›´æ–° (<code>update</code>) æ“ä½œ</strong> éƒ½è¿è¡Œåœ¨<strong>åŒä¸€ä¸ªäº‹åŠ¡ä¸­</strong>ã€‚å³ï¼š</p>
<ul>
<li><code>query(&quot;SELECT ... FOR UPDATE&quot;)</code> è¯»å–æ•°æ®å¹¶åŠ é”ï¼Œä½†<strong>ä¸ä¼šç«‹å³æäº¤</strong>ã€‚</li>
<li>åªæœ‰ <code>updateEntry()</code> æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œäº‹åŠ¡æ‰ä¼šè¢«<strong>ç»Ÿä¸€æäº¤</strong>ã€‚</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦æ•´ä¸ªæ–¹æ³•æ‰§è¡Œå®Œæ‰èƒ½æäº¤äº‹åŠ¡ï¼Ÿ</strong></p>
<p>è¿™æ˜¯å› ä¸º Spring é»˜è®¤çš„ <strong>äº‹åŠ¡æäº¤æ—¶æœº</strong> æ˜¯<strong>æ–¹æ³•æ‰§è¡Œå®Œæ¯•åæäº¤äº‹åŠ¡</strong>ï¼Œå³ <strong>â€œæ–¹æ³•çº§åˆ«çš„äº‹åŠ¡ç®¡ç†â€</strong>ï¼š</p>
<ol>
<li>äº‹åŠ¡åœ¨ <code>updateEntry()</code> <strong>æ–¹æ³•å¼€å§‹æ—¶å¼€å¯</strong>ï¼ˆå¦‚æœä¸Šå±‚æ²¡æœ‰äº‹åŠ¡ï¼‰ã€‚</li>
<li><strong>æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½åœ¨è¯¥äº‹åŠ¡ä¸­æ‰§è¡Œ</strong>ï¼ŒåŒ…æ‹¬ <code>query</code> å’Œ <code>update</code>ã€‚</li>
<li>æ–¹æ³•ç»“æŸåï¼ŒSpring <strong>è‡ªåŠ¨æäº¤äº‹åŠ¡</strong>ï¼ˆæˆ–åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶å›æ»šï¼‰ã€‚</li>
</ol>
<p><strong>å¹¶å‘æƒ…å†µä¸‹çš„è¡Œä¸º</strong></p>
<p>å¤šä¸ªçº¿ç¨‹è°ƒç”¨ <code>updateEntry(id)</code>ï¼š</p>
<ul>
<li><strong>å¦‚æœä¼ å…¥ç›¸åŒçš„ <code>id</code></strong>ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹è·å–è¡Œçº§é”ï¼Œå…¶ä»–çº¿ç¨‹<strong>å¿…é¡»ç­‰å¾…å®ƒçš„äº‹åŠ¡æäº¤æˆ–å›æ»š</strong>ï¼Œç„¶åæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</li>
<li>è¿™ä¿è¯äº†åŒä¸€æ¡è®°å½•<strong>ä¸ä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹</strong>ï¼Œé¿å…å¹¶å‘å†²çªã€‚</li>
</ul>
<h4 id="10-1-2-ä¹è§‚é”"><a href="#10-1-2-ä¹è§‚é”" class="headerlink" title="10.1.2 ä¹è§‚é”"></a>10.1.2 ä¹è§‚é”</h4><p><strong>ä¹è§‚é”</strong> è®¤ä¸ºæ•°æ®åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿå†²çªï¼Œå› æ­¤åœ¨è®¿é—®è®°å½•æ—¶<strong>ä¸ä¼šåŠ æ’å®ƒé”</strong>ï¼Œè€Œæ˜¯åœ¨æäº¤æ›´æ–°æ—¶<strong>æ£€æµ‹æ˜¯å¦å‘ç”Ÿæ•°æ®å†²çª</strong>ã€‚å…¶æ ¸å¿ƒåŸç†æ˜¯ï¼š</p>
<ol>
<li><p><strong>æŸ¥è¯¢æ•°æ®</strong> æ—¶è·å– <code>version</code>ï¼ˆæˆ–å…¶ä»–çŠ¶æ€å­—æ®µï¼‰ã€‚</p>
</li>
<li><p><strong>æ›´æ–°æ•°æ®</strong> æ—¶ï¼Œç¡®ä¿ <code>version</code> æœªå‘ç”Ÿå˜åŒ–ï¼ˆå³ <code>WHERE version = ?</code>ï¼‰ã€‚</p>
</li>
<li><p>é€šè¿‡ <code>UPDATE</code> å½±å“çš„è¡Œæ•°</p>
<p> åˆ¤æ–­æ˜¯å¦æˆåŠŸï¼š</p>
<ul>
<li><strong>æˆåŠŸ</strong>ï¼ˆ<code>UPDATE</code> å½±å“è¡Œæ•° &gt; 0ï¼‰ï¼šè¯´æ˜ <code>version</code> æœªè¢«ä¿®æ”¹ï¼Œæ›´æ–°å®Œæˆã€‚</li>
<li><strong>å¤±è´¥</strong>ï¼ˆ<code>UPDATE</code> å½±å“è¡Œæ•° &#x3D; 0ï¼‰ï¼šè¯´æ˜ <code>version</code> å·²è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œæ›´æ–°å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡è¯•æˆ–å…¶ä»–å¤„ç†ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ç¤ºä¾‹ä»£ç </strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">updateEntry</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">    <span class="comment">// (1) æŸ¥è¯¢è®°å½•ï¼Œè·å–å½“å‰ version</span></span><br><span class="line">    <span class="type">EntryObject</span> <span class="variable">entry</span> <span class="operator">=</span> query(<span class="string">&quot;SELECT id, name, age, version FROM table1 WHERE id = #&#123;id&#125;&quot;</span>, id);</span><br><span class="line">    <span class="keyword">if</span> (entry == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// è®°å½•ä¸å­˜åœ¨</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (2) è®¡ç®—ä¿®æ”¹åçš„å€¼</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> generatorName(entry);</span><br><span class="line">    entry.setName(name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (3) ä½¿ç”¨ä¹è§‚é”è¿›è¡Œæ›´æ–°ï¼Œç¡®ä¿ version æœªè¢«ä¿®æ”¹</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> update(</span><br><span class="line">        <span class="string">&quot;UPDATE table1 SET name = #&#123;name&#125;, age = #&#123;age&#125;, version = version + 1 &quot;</span> +</span><br><span class="line">        <span class="string">&quot;WHERE id = #&#123;id&#125; AND version = #&#123;version&#125;&quot;</span>,</span><br><span class="line">        entry</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (4) è¿”å›æ›´æ–°ç»“æœï¼Œåˆ¤æ–­æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="10-2-å…¬å¹³é”ä¸éå…¬å¹³é”"><a href="#10-2-å…¬å¹³é”ä¸éå…¬å¹³é”" class="headerlink" title="10.2 å…¬å¹³é”ä¸éå…¬å¹³é”"></a>10.2 å…¬å¹³é”ä¸éå…¬å¹³é”</h3><h4 id="10-2-1-å…¬å¹³é”-vs-éå…¬å¹³é”"><a href="#10-2-1-å…¬å¹³é”-vs-éå…¬å¹³é”" class="headerlink" title="10.2.1 å…¬å¹³é” vs. éå…¬å¹³é”"></a>10.2.1 å…¬å¹³é” vs. éå…¬å¹³é”</h4><ul>
<li><strong>å…¬å¹³é”</strong>ï¼šçº¿ç¨‹æŒ‰ç…§<strong>è¯·æ±‚é”çš„å…ˆåé¡ºåº</strong>ä¾æ¬¡è·å–é”ï¼ˆFIFOï¼‰ã€‚</li>
<li><strong>éå…¬å¹³é”</strong>ï¼šçº¿ç¨‹è·å–é”<strong>ä¸è€ƒè™‘è¯·æ±‚çš„é¡ºåº</strong>ï¼Œå¯ä»¥ç›´æ¥å°è¯•æŠ¢å é”ï¼Œæé«˜ååé‡ã€‚</li>
</ul>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFairLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºå…¬å¹³é”</span></span><br><span class="line">    <span class="type">ReentrantLock</span> <span class="variable">fairLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»ºéå…¬å¹³é”ï¼ˆé»˜è®¤ï¼‰</span></span><br><span class="line">    <span class="type">ReentrantLock</span> <span class="variable">unfairLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="10-2-2-ä¸ºä»€ä¹ˆéå…¬å¹³é”æ€§èƒ½æ›´å¥½ï¼Ÿ"><a href="#10-2-2-ä¸ºä»€ä¹ˆéå…¬å¹³é”æ€§èƒ½æ›´å¥½ï¼Ÿ" class="headerlink" title="10.2.2 ä¸ºä»€ä¹ˆéå…¬å¹³é”æ€§èƒ½æ›´å¥½ï¼Ÿ"></a>10.2.2 ä¸ºä»€ä¹ˆéå…¬å¹³é”æ€§èƒ½æ›´å¥½ï¼Ÿ</h4><p><strong>å…¬å¹³é”çš„æ€§èƒ½å¼€é”€ä¸»è¦æ¥è‡ªäºä¸¤ä¸ªæ–¹é¢ï¼š</strong></p>
<ol>
<li><strong>çº¿ç¨‹åˆ‡æ¢æˆæœ¬é«˜</strong><ul>
<li>å…¬å¹³é”éœ€è¦ç»´æŠ¤ä¸€ä¸ª<strong>ç­‰å¾…é˜Ÿåˆ—</strong>ï¼Œä¿è¯çº¿ç¨‹æŒ‰ç…§<strong>å…ˆæ¥å…ˆå¾—</strong>çš„é¡ºåºè·å–é”ã€‚</li>
<li>å½“é”è¢«é‡Šæ”¾æ—¶ï¼Œ<strong>éœ€è¦é€šçŸ¥é˜Ÿåˆ—ä¸­æœ€æ—©ç­‰å¾…çš„çº¿ç¨‹</strong>ï¼Œå¯èƒ½æ¶‰åŠä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¢åŠ äº†å¼€é”€ã€‚</li>
</ul>
</li>
<li><strong>ç«äº‰æ¿€çƒˆæ—¶çš„ååé‡ä¸‹é™</strong><ul>
<li><strong>éå…¬å¹³é”å…è®¸â€œæŠ¢å â€</strong>ï¼Œå½“é”é‡Šæ”¾æ—¶ï¼Œ<strong>å½“å‰çº¿ç¨‹æˆ–è€…æ–°æ¥çš„çº¿ç¨‹å¯ä»¥ç›´æ¥å°è¯•è·å–é”</strong>ï¼Œå‡å°‘çº¿ç¨‹è°ƒåº¦çš„ç­‰å¾…æ—¶é—´ã€‚</li>
<li><strong>å…¬å¹³é”åˆ™å¿…é¡»ä¸¥æ ¼æŒ‰ç…§é¡ºåº</strong>ï¼Œå³ä½¿å½“å‰çº¿ç¨‹åˆšé‡Šæ”¾é”ï¼Œä»ç„¶è¦è®©é˜Ÿåˆ—ä¸­æœ€è€çš„çº¿ç¨‹å…ˆæ‰§è¡Œï¼Œå¯¼è‡´çº¿ç¨‹ä¸èƒ½<strong>å……åˆ†åˆ©ç”¨ CPU</strong>ã€‚</li>
</ul>
</li>
</ol>
<h4 id="10-2-3-ä»€ä¹ˆæ—¶å€™é€‰æ‹©å…¬å¹³é”ï¼Ÿ"><a href="#10-2-3-ä»€ä¹ˆæ—¶å€™é€‰æ‹©å…¬å¹³é”ï¼Ÿ" class="headerlink" title="10.2.3 ä»€ä¹ˆæ—¶å€™é€‰æ‹©å…¬å¹³é”ï¼Ÿ"></a>10.2.3 ä»€ä¹ˆæ—¶å€™é€‰æ‹©å…¬å¹³é”ï¼Ÿ</h4><p>å°½ç®¡<strong>éå…¬å¹³é”é€šå¸¸æ€§èƒ½æ›´å¥½</strong>ï¼Œä½†åœ¨ä»¥ä¸‹æƒ…å†µï¼Œå¯èƒ½ä»ç„¶éœ€è¦<strong>ä½¿ç”¨å…¬å¹³é”</strong>ï¼š</p>
<ul>
<li><strong>éœ€è¦ä¸¥æ ¼ä¿è¯å…ˆæ¥å…ˆå¾—</strong>ï¼Œé¿å…çº¿ç¨‹â€œé¥¥é¥¿â€ï¼ˆå¦‚ä¸€äº›é™æµæ§åˆ¶ã€é“¶è¡Œè½¬è´¦ç­‰åœºæ™¯ï¼‰ã€‚</li>
<li><strong>ä¸šåŠ¡å¯¹å…¬å¹³æ€§è¦æ±‚è¾ƒé«˜</strong>ï¼Œæ¯”å¦‚ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼Œç¡®ä¿ä»»åŠ¡æŒ‰ç…§æäº¤é¡ºåºæ‰§è¡Œã€‚</li>
</ul>
<h3 id="10-3-ç‹¬å é”ä¸å…±äº«é”"><a href="#10-3-ç‹¬å é”ä¸å…±äº«é”" class="headerlink" title="10.3 ç‹¬å é”ä¸å…±äº«é”"></a>10.3 ç‹¬å é”ä¸å…±äº«é”</h3><h4 id="10-3-1-ç‹¬å é”"><a href="#10-3-1-ç‹¬å é”" class="headerlink" title="10.3.1 ç‹¬å é”"></a>10.3.1 ç‹¬å é”</h4><p><strong>æ¦‚å¿µ</strong></p>
<ul>
<li><strong>ç‹¬å é”</strong>ï¼ˆåˆç§°<strong>å†™é”</strong>ï¼‰ï¼ŒæŒ‡çš„æ˜¯åœ¨åŒä¸€æ—¶é—´<strong>åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ˆæˆ–äº‹åŠ¡ï¼‰è·å–è¯¥é”</strong>ï¼Œå…¶ä»–çº¿ç¨‹<strong>æ— æ³•åŒæ—¶è·å–</strong>ï¼Œå³ä½¿æ˜¯è¯»å–æ“ä½œä¹Ÿéœ€è¦ç­‰å¾…ã€‚</li>
<li>å…¸å‹åº”ç”¨ï¼š<code>ReentrantLock</code>ã€æ•°æ®åº“ <code>SELECT ... FOR UPDATE</code>ã€<code>synchronized</code> å…³é”®å­—ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExclusiveLockDemo</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(); <span class="comment">// é»˜è®¤æ˜¯éå…¬å¹³é”</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">criticalSection</span><span class="params">()</span> &#123;</span><br><span class="line">            lock.lock(); <span class="comment">// è·å–ç‹¬å é”</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; è·å–ç‹¬å é”ï¼Œæ‰§è¡Œå…³é”®æ“ä½œ...&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>); <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock(); <span class="comment">// é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testExclusiveLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ExclusiveLockDemo</span> <span class="variable">demo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExclusiveLockDemo</span>();</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> demo::criticalSection;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task, <span class="string">&quot;çº¿ç¨‹A&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task, <span class="string">&quot;çº¿ç¨‹B&quot;</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç‰¹ç‚¹</strong></p>
<p>é€‚ç”¨äº<strong>éœ€è¦ä¿è¯æ•°æ®ä¸€è‡´æ€§</strong>çš„åœºæ™¯ï¼Œå¦‚æ•°æ®åº“æ›´æ–°ã€ä¸´ç•ŒåŒºæ“ä½œã€‚<br>ååé‡è¾ƒä½**ï¼Œå› ä¸ºåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®èµ„æºï¼Œå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹é•¿æ—¶é—´ç­‰å¾…ã€‚</p>
<h4 id="10-3-2-å…±äº«é”"><a href="#10-3-2-å…±äº«é”" class="headerlink" title="10.3.2 å…±äº«é”"></a>10.3.2 å…±äº«é”</h4><p><strong>æ¦‚å¿µ</strong></p>
<ul>
<li><strong>å…±äº«é”</strong>ï¼ˆåˆç§°<strong>è¯»é”</strong>ï¼‰ï¼ŒæŒ‡çš„æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥<strong>åŒæ—¶è·å–è¯¥é”è¿›è¡Œè¯»å–</strong>ï¼Œä½†å¦‚æœæœ‰çº¿ç¨‹ç”³è¯·å†™æ“ä½œï¼ˆç‹¬å é”ï¼‰ï¼Œåˆ™æ‰€æœ‰å…±äº«é”ä¼šè¢«é˜»å¡ã€‚</li>
<li>å…¸å‹åº”ç”¨ï¼š<code>ReentrantReadWriteLock</code> çš„ <strong>readLock()</strong>ã€æ•°æ®åº“ <code>SELECT ... LOCK IN SHARE MODE</code>ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…±äº«é”</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SharedLockDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantReadWriteLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readOperation</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.readLock().lock(); <span class="comment">// å…±äº«é”</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; è·å–å…±äº«é”ï¼Œæ‰§è¡Œè¯»å–æ“ä½œ...&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSharedLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SharedLockDemo</span> <span class="variable">demo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SharedLockDemo</span>();</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> demo::readOperation;</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task, <span class="string">&quot;çº¿ç¨‹A&quot;</span>);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task, <span class="string">&quot;çº¿ç¨‹B&quot;</span>);</span><br><span class="line"></span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç‰¹ç‚¹</strong></p>
<p><strong>å¹¶å‘èƒ½åŠ›å¼º</strong>ï¼Œå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶è¯»å–æ•°æ®ï¼Œæé«˜ååé‡ã€‚<br><strong>ä¸èƒ½å†™å…¥æ•°æ®</strong>ï¼Œå¦‚æœéœ€è¦å†™æ“ä½œï¼Œéœ€è¦å‡çº§ä¸ºç‹¬å é”ã€‚</p>
<h3 id="10-4-å¯é‡å…¥é”"><a href="#10-4-å¯é‡å…¥é”" class="headerlink" title="10.4 å¯é‡å…¥é”"></a>10.4 å¯é‡å…¥é”</h3><p><strong>æ¦‚å¿µ</strong></p>
<p><strong>å¯é‡å…¥é”</strong>ï¼Œåˆç§°ä¸º<strong>é€’å½’é”</strong>ï¼Œæ˜¯ä¸€ç§å¯ä»¥ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å–çš„é”ã€‚åœ¨è¯¥é”æœºåˆ¶ä¸‹ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹å·²ç»è·å–äº†é”ï¼Œå®ƒå¯ä»¥å†æ¬¡è·å–è¯¥é”è€Œä¸ä¼šå‘ç”Ÿæ­»é”ã€‚è¿™ç§é”å…è®¸åŒä¸€çº¿ç¨‹åœ¨ä¸åŒçš„ä»£ç æ®µä¸­å¤šæ¬¡è·å¾—é”ï¼Œå¹¶ä¸”æ¯æ¬¡è·å–é”æ—¶éƒ½éœ€è¦è°ƒç”¨ <code>unlock()</code> é‡Šæ”¾é”çš„æ¬¡æ•°æ‰èƒ½çœŸæ­£é‡Šæ”¾é”ã€‚</p>
<p><strong>ç‰¹ç‚¹</strong></p>
<ol>
<li><strong>åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—é”ä¸ä¼šå‘ç”Ÿæ­»é”</strong>ã€‚</li>
<li>æ¯å½“çº¿ç¨‹è·å–é”æ—¶ï¼Œé”çš„å†…éƒ¨è®¡æ•°å™¨ä¼šå¢åŠ ï¼Œ<code>unlock()</code> è¢«è°ƒç”¨æ—¶ï¼Œè®¡æ•°å™¨å‡å°‘ï¼Œç›´åˆ°è®¡æ•°å™¨ä¸º 0 æ—¶æ‰ä¼šçœŸæ­£é‡Šæ”¾é”ã€‚</li>
<li><strong>æé«˜ä»£ç çš„å¯é‡å…¥æ€§</strong>ï¼Œé¿å…å› åŒä¸€çº¿ç¨‹åœ¨å¤šä¸ªåœ°æ–¹åŠ é”æ—¶å‡ºç°æ­»é”æˆ–æ— æ³•æ­£å¸¸è§£é”çš„æƒ…å†µã€‚</li>
</ol>
<p><strong>å®ç°åŸç†</strong></p>
<ul>
<li>å¯é‡å…¥é”é€šè¿‡ä¸ºæ¯ä¸ªçº¿ç¨‹<strong>è®°å½•é”çš„æŒæœ‰æ¬¡æ•°</strong>æ¥å®ç°ã€‚å½“ä¸€ä¸ªçº¿ç¨‹ç¬¬ä¸€æ¬¡è·å¾—é”æ—¶ï¼Œé”çš„è®¡æ•°å™¨å€¼ä¸º 1ã€‚å½“åŒä¸€çº¿ç¨‹å†æ¬¡è¯·æ±‚è¯¥é”æ—¶ï¼Œè®¡æ•°å™¨å€¼ä¼šå¢åŠ ã€‚åªæœ‰å½“é”çš„è®¡æ•°å™¨å€¼å½’é›¶æ—¶ï¼Œé”æ‰ä¼šè¢«é‡Šæ”¾ã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ä»£ç </strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯é‡å…¥é”</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantLockDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹æ³•Aï¼Œè°ƒç”¨æ–¹æ³•B</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">methodA</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock(); <span class="comment">// ç¬¬ä¸€æ¬¡è·å–é”</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; è·å–äº†é”ï¼Œæ‰§è¡Œæ–¹æ³•A&quot;</span>);</span><br><span class="line">            methodB(); <span class="comment">// è°ƒç”¨æ–¹æ³•B</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock(); <span class="comment">// è§£é”</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–¹æ³•B</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">methodB</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock(); <span class="comment">// ç¬¬äºŒæ¬¡è·å–é”</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; è·å–äº†é”ï¼Œæ‰§è¡Œæ–¹æ³•B&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock(); <span class="comment">// è§£é”</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReentrantLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ReentrantLockDemo</span> <span class="variable">demo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLockDemo</span>();</span><br><span class="line">    demo.methodA();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è§£é‡Š</strong></p>
<ul>
<li>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ<code>methodA()</code> è·å–äº†é”ï¼Œå¹¶åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨äº† <code>methodB()</code>ã€‚ç”±äº <code>methodB()</code> ä¸­ä¹Ÿè¯·æ±‚äº†ç›¸åŒçš„é”ï¼Œä½†æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ <code>main</code> åœ¨åŒä¸€ä¸ªé”ä¸Šé‡å¤è¯·æ±‚æ—¶ï¼Œé”å¹¶ä¸ä¼šé˜»å¡è‡ªå·±ã€‚</li>
<li>è¿™ç§è¡Œä¸ºåœ¨æ²¡æœ‰å¯é‡å…¥é”çš„æƒ…å†µä¸‹æ˜¯ä¸å¯è¡Œçš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ­»é”ã€‚</li>
</ul>
<p><strong>å¸¸è§å¯é‡å…¥é”å®ç°</strong></p>
<ol>
<li><strong><code>ReentrantLock</code></strong>ï¼š<ul>
<li><code>ReentrantLock</code> æ˜¯ä¸€ç§æ˜¾å¼é”ï¼Œæ”¯æŒå¯é‡å…¥ï¼Œå¹¶ä¸”æä¾›æ¯” <code>synchronized</code> æ›´å¼ºå¤§çš„é”å®šæ§åˆ¶ï¼Œä¾‹å¦‚ <strong>å…¬å¹³æ€§</strong>ï¼ˆå…¬å¹³é”ï¼‰å’Œ <strong>éå…¬å¹³æ€§</strong>ï¼ˆéå…¬å¹³é”ï¼‰çš„é€‰æ‹©ã€‚</li>
</ul>
</li>
<li><strong><code>synchronized</code></strong>ï¼š<ul>
<li>Java çš„å†…ç½®é”æœºåˆ¶ï¼ˆ<code>synchronized</code>ï¼‰æœ¬è´¨ä¸Šä¹Ÿæ˜¯å¯é‡å…¥çš„ã€‚å³åŒä¸€çº¿ç¨‹å¯ä»¥å¤šæ¬¡è¿›å…¥åŒæ­¥ä»£ç å—è€Œä¸è¢«é˜»å¡ã€‚</li>
</ul>
</li>
</ol>
<h3 id="10-5-è‡ªæ—‹é”"><a href="#10-5-è‡ªæ—‹é”" class="headerlink" title="10.5 è‡ªæ—‹é”"></a>10.5 è‡ªæ—‹é”</h3><p><strong>æ¦‚å¿µ</strong></p>
<p><strong>è‡ªæ—‹é”</strong> æ˜¯ä¸€ç§é€šè¿‡åå¤æ£€æŸ¥æŸä¸ªæ¡ä»¶æ˜¯å¦æ»¡è¶³è€Œç­‰å¾…çš„é”æœºåˆ¶ã€‚åœ¨è‡ªæ—‹é”ä¸­ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å–é”æ—¶ï¼Œå¦‚æœé”å·²ç»è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œçº¿ç¨‹ä¸ä¼šè¢«æŒ‚èµ·æˆ–ä¼‘çœ ï¼Œè€Œæ˜¯ä¼šåœ¨å¾ªç¯ä¸­â€œè‡ªæ—‹â€åå¤æ£€æŸ¥é”çš„çŠ¶æ€ã€‚è¿™ç§è‡ªæ—‹æ“ä½œå¯ä»¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œé€‚ç”¨äºé”æŒæœ‰æ—¶é—´éå¸¸çŸ­çš„åœºæ™¯ã€‚</p>
<p>è‡ªæ—‹é”æ˜¯ä¸€ç§è½»é‡çº§çš„é”ï¼Œå®ƒä¸åƒä¼ ç»Ÿçš„é˜»å¡é”ï¼ˆå¦‚ <code>ReentrantLock</code>ï¼‰é‚£æ ·ä¼šå°†çº¿ç¨‹æŒ‚èµ·ï¼Œè€Œæ˜¯é€šè¿‡å¿™ç­‰å¾…ï¼ˆä¸æ–­è½®è¯¢ï¼‰æ¥åˆ¤æ–­é”æ˜¯å¦å¯ç”¨ã€‚</p>
<p><strong>è‡ªæ—‹é”çš„ç‰¹ç‚¹</strong></p>
<ul>
<li><strong>æ— é˜»å¡</strong>ï¼šçº¿ç¨‹ä¸ä¼šè¿›å…¥æ“ä½œç³»ç»Ÿçš„è°ƒåº¦é˜Ÿåˆ—ï¼Œè€Œæ˜¯ä¼šæŒç»­æ£€æŸ¥é”çš„çŠ¶æ€ï¼Œç›´åˆ°æˆåŠŸè·å–é”ã€‚</li>
<li><strong>å¿™ç­‰å¾…</strong>ï¼šçº¿ç¨‹ä¼šä¸æ–­æ¶ˆè€— CPU èµ„æºï¼Œæ‰§è¡Œä¸€ä¸ªçŸ­æ—¶é—´çš„è‡ªæ—‹ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé€‚åˆé”æŒæœ‰æ—¶é—´éå¸¸çŸ­çš„åœºæ™¯ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡å’Œå”¤é†’çš„å¼€é”€ã€‚</li>
<li><strong>æ€§èƒ½æ¶ˆè€—</strong>ï¼šè‡ªæ—‹é”æœ¬èº«æ¶ˆè€— CPU èµ„æºï¼Œå› æ­¤ä¸é€‚ç”¨äºé”æŒæœ‰æ—¶é—´é•¿æˆ–ç«äº‰ä¸¥é‡çš„æƒ…å†µã€‚</li>
</ul>
<p><strong>ç¤ºä¾‹ä»£ç </strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªæ—‹é”</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpinLock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// é”æ ‡å¿—ï¼Œfalseè¡¨ç¤ºæ²¡æœ‰é”ï¼Œtrueè¡¨ç¤ºæœ‰é”</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                <span class="keyword">if</span> (compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123; <span class="comment">// æ¯”è¾ƒå¹¶è®¾ç½®æ ‡å¿—ä½</span></span><br><span class="line">                    <span class="keyword">return</span>; <span class="comment">// æˆåŠŸè·å–é”</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        flag = <span class="literal">false</span>; <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨CASï¼ˆCompare And Swapï¼‰è¿›è¡Œé”çŠ¶æ€çš„åŸå­æ“ä½œ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">boolean</span> expected, <span class="type">boolean</span> newValue)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (flag == expected) &#123;</span><br><span class="line">            flag = newValue;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSpinLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SpinLock</span> <span class="variable">spinLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpinLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">        spinLock.lock(); <span class="comment">// è·å–é”</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; è·å–é”ï¼Œæ‰§è¡Œæ“ä½œ...&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>); <span class="comment">// æ¨¡æ‹Ÿæ“ä½œ</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            spinLock.unlock(); <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; é‡Šæ”¾é”&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task, <span class="string">&quot;çº¿ç¨‹A&quot;</span>);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task, <span class="string">&quot;çº¿ç¨‹B&quot;</span>);</span><br><span class="line"></span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è§£é‡Š</strong></p>
<ul>
<li>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ<code>SpinLock</code> ç±»å®ç°äº†ä¸€ä¸ªç®€å•çš„è‡ªæ—‹é”ã€‚é€šè¿‡ <code>flag</code> å˜é‡æ§åˆ¶é”çš„çŠ¶æ€ã€‚å½“ <code>lock()</code> è¢«è°ƒç”¨æ—¶ï¼Œçº¿ç¨‹ä¼šé€šè¿‡ <code>compareAndSet()</code> æ–¹æ³•æ£€æŸ¥å¹¶è®¾ç½® <code>flag</code>ï¼Œå¦‚æœé”æœªè¢«å ç”¨ï¼Œåˆ™æˆåŠŸè·å–é”å¹¶è¿›å…¥ä¸´ç•ŒåŒºã€‚</li>
<li>è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªå…¸å‹çš„è‡ªæ—‹é”æ“ä½œï¼Œçº¿ç¨‹ä¼šä¸æ–­è‡ªæ—‹ï¼Œç›´åˆ°æˆåŠŸè·å–é”ã€‚</li>
</ul>
</div>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2023-04-10</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« Ethan</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/Java/'>
                            Java
                        </a>
                    
                        <a href='/tags/JUC/'>
                            JUC
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/JUC/'>
                            JUC
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    
        
            
    
            <div class="post-footer-pre-next">
                
                    <span>ä¸Šä¸€ç¯‡ï¼š<a href='/2023/04/15/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B_03/'>ä¸‰ã€Javaå¹¶å‘ç¼–ç¨‹-ThreadLocalRandom CopyOnWriteArrayList åŸå­æ“ä½œæºç è§£æ</a></span>
                

                
                    <span class="post-footer-pre-next-last-span-right">ä¸‹ä¸€ç¯‡ï¼š<a href="/2023/04/01/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B_01/">ä¸€ã€Javaå¹¶å‘ç¼–ç¨‹-çº¿ç¨‹åŸºç¡€</a>
                    </span>
                
            </div>
    
        
    

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            Â© 1949-2025 China 

            
                

            
                
                    / <a href="/contact/"> è”ç³» </a>
                

            
                
                    / <a href="/support/"> æ”¯æŒ </a>
                

            
        </span>
       
    
</div>



<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>âœ¨&#34;The only way to achieve the impossible is to believe it is possible.&#34; âœ¨</span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery/lightgallery.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-thumbnail.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-fullscreen.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-autoplay.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-zoom.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-rotate.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-paper.umd.min.js"></script>




<script type="text/javascript">
     
    if (typeof lightGallery !== "undefined") {
        var options1 = {
            selector: '.gallery-item',
            plugins: [lgThumbnail, lgFullscreen, lgAutoplay, lgZoom, lgRotate, lgPager], // å¯ç”¨æ’ä»¶
            thumbnail: true,          // æ˜¾ç¤ºç¼©ç•¥å›¾
            zoom: true,               // å¯ç”¨ç¼©æ”¾åŠŸ
            rotate: true,             // å¯ç”¨æ—‹è½¬åŠŸèƒ½èƒ½
            autoplay: true,        // å¯ç”¨è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
            fullScreen: true,      // å¯ç”¨å…¨å±åŠŸèƒ½
            pager: false, //é¡µç ,
            zoomFromOrigin: true,   // ä»åŸå§‹ä½ç½®ç¼©æ”¾
            actualSize: true,       // å¯ç”¨æŸ¥çœ‹å®é™…å¤§å°çš„åŠŸèƒ½
            enableZoomAfter: 300,    // å»¶è¿Ÿç¼©æ”¾ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå¯ç¼©æ”¾
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1); // ä¿®å¤é€‰æ‹©å™¨
    }
    
</script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> 

                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>